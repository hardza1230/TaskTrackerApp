<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <!-- CSP Meta Tag for Electron Security -->
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com https://cdnjs.cloudflare.com;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Task Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
            background-color: #f0f9ff; /* blue-50 */
        }
        .progress-bar-fg {
            background-color: #22c55e; /* green-500 */
            transition: width 0.3s ease-in-out;
        }
        .task-card {
            transition: all 0.2s ease-in-out;
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        .task-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .task-item input:checked + label {
            text-decoration: line-through;
            color: #6b7280; /* gray-500 */
        }
        .task-item input:checked + label a, .task-item input:checked + label button {
            color: #6b7280;
        }
        .task-link-btn {
            background: none;
            border: none;
            padding: 0;
            color: #2563eb; /* blue-600 */
            cursor: pointer;
            text-align: left;
        }
        .shortcut-btn {
            background-color: #ffffff;
            color: #374151; /* gray-700 */
            border: 1px solid #d1d5db; /* gray-300 */
            transition: all 0.2s ease-in-out;
        }
        .shortcut-btn:hover {
            background-color: #f9fafb; /* gray-50 */
            border-color: #9ca3af; /* gray-400 */
            transform: translateY(-2px);
        }
        /* Modal styles */
        .modal-overlay {
            transition: opacity 0.2s ease-in-out;
            z-index: 50;
        }
        .modal-box {
            transition: all 0.2s ease-in-out;
        }
        .edit-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #9ca3af; /* gray-400 */
        }
        .edit-action-btn:hover {
            color: #ef4444; /* red-500 */
        }
        /* Icon Picker Styles */
        .icon-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 0.5rem;
        }
        .icon-picker-item {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .icon-picker-item:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Header -->
        <header class="mb-6">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                 <h1 class="text-3xl md:text-4xl font-bold text-blue-800">Daily Workflow Tracker</h1>
                 <div class="flex items-center gap-2">
                    <input type="date" id="date-picker" class="bg-white p-2 border border-gray-300 rounded-lg shadow-sm">
                    <button id="today-btn" class="shortcut-btn rounded-lg px-4 py-2 font-semibold">วันนี้</button>
                 </div>
            </div>
            
            <div class="bg-white p-4 rounded-xl shadow-md border border-gray-200 mb-6">
                <h3 class="font-bold text-lg text-gray-700 mb-3">Tools & Shortcuts</h3>
                <div id="shortcuts-container" class="flex flex-wrap items-center gap-4">
                    <!-- Shortcuts will be injected here -->
                </div>
            </div>
           
            <div class="bg-white p-5 rounded-xl shadow-md border border-gray-200">
                <div class="flex flex-wrap justify-between items-center mb-2 gap-2">
                    <h2 class="text-xl font-bold text-gray-800">ภาพรวมความคืบหน้า</h2>
                    <div class="flex items-center gap-4">
                        <span id="main-progress-details" class="font-semibold text-gray-600 text-lg">0/0 Tasks</span>
                        <span id="main-progress-text" class="text-2xl font-bold text-green-600">0%</span>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div id="main-progress-bar" class="progress-bar-fg h-4 rounded-full"></div>
                </div>
            </div>
        </header>

        <!-- Control Buttons -->
        <div class="flex justify-end gap-3 mb-4">
            <button id="edit-btn" class="shortcut-btn rounded-lg px-4 py-2 font-semibold bg-blue-500 text-white border-blue-600 hover:bg-blue-600"><i class="fas fa-pencil-alt mr-2"></i>แก้ไขรายการ</button>
            <button id="clear-btn" class="shortcut-btn rounded-lg px-4 py-2 font-semibold bg-red-500 text-white border-red-600 hover:bg-red-600"><i class="fas fa-trash mr-2"></i>ล้างข้อมูลวันนี้</button>
        </div>

        <!-- Main Task Grid with dynamic height -->
        <main id="task-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 items-start">
            <!-- Task cards will be injected here -->
        </main>
    </div>

    <!-- Modals -->
    <div id="clear-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-box bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform scale-95">
            <h3 class="text-xl font-bold mb-4">ยืนยันการล้างข้อมูล</h3>
            <p class="text-gray-600 mb-6">คุณแน่ใจหรือไม่ว่าต้องการล้างข้อมูลงานทั้งหมดสำหรับวันที่เลือก? การกระทำนี้ไม่สามารถย้อนกลับได้</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-clear-btn" class="shortcut-btn rounded-lg px-4 py-2 font-semibold">ยกเลิก</button>
                <button id="confirm-clear-btn" class="shortcut-btn rounded-lg px-4 py-2 font-semibold bg-red-500 text-white border-red-600 hover:bg-red-600">ยืนยัน</button>
            </div>
        </div>
    </div>

    <div id="icon-picker-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-box bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">เลือกไอคอน</h3>
                <button id="close-icon-picker-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="icon-picker-grid" class="icon-picker-grid max-h-64 overflow-y-auto">
                <!-- Icons will be injected here -->
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- UI Elements ---
            const taskGrid = document.getElementById('task-grid');
            const datePicker = document.getElementById('date-picker');
            const todayBtn = document.getElementById('today-btn');
            const editBtn = document.getElementById('edit-btn');
            const clearBtn = document.getElementById('clear-btn');
            const shortcutsContainer = document.getElementById('shortcuts-container');
            // Modals
            const clearModal = document.getElementById('clear-modal');
            const cancelClearBtn = document.getElementById('cancel-clear-btn');
            const confirmClearBtn = document.getElementById('confirm-clear-btn');
            const iconPickerModal = document.getElementById('icon-picker-modal');
            const closeIconPickerBtn = document.getElementById('close-icon-picker-btn');
            const iconPickerGrid = document.getElementById('icon-picker-grid');

            // --- State Management ---
            let currentDate = new Date();
            let isEditMode = false;
            let tasksMasterData = [];
            let shortcutsMasterData = [];
            let currentShortcutIndex = null;

            // --- Default & Available Data ---
            const availableIcons = ['fa-link', 'fa-shield-halved', 'fa-chart-line', 'fa-file-alt', 'fa-cogs', 'fa-database', 'fa-server', 'fa-cloud', 'fa-envelope', 'fa-folder-open', 'fa-globe', 'fa-print', 'fa-calculator', 'fa-camera', 'fa-video', 'fa-music'];
            const defaultTasksData = [
                 { id: 1, title: 'Open Styline', tasks: [
                    { name: 'เปิด Styline Daily report ใน Styline', link: '#' }, { name: 'เปิดแผนพิมพ์', link: '#' }, { name: 'เปลี่ยนชื่อไฟล์อัพเดทวันที่', link: '' }, { name: 'Refresh ไฟล์แผนพิมพ์', link: '' }
                ]},
                { id: 2, title: 'Open Power BI', tasks: [] },
                { id: 3, title: 'Open BIS', tasks: [] },
                { id: 4, title: 'Update ผลผลิตใน Power BI', tasks: [
                    { name: 'Update ข้อมูลใน excel ผลผลิต', link: '#' }, { name: 'Refresh Power BI (1. GHCQ Production)', link: '#' }
                ]},
                { id: 5, title: 'ส่งเมลผลผลิต', tasks: [ { name: 'อัพเดทผลผลิตวันที่', link: '' } ]},
                { id: 6, title: 'Update Order Status', tasks: [
                    { name: 'เปิดไฟล์ Order Status จาก Styline', link: '#' }, { name: 'อัพเดท Order Status ด้วยไฟล์ excel แผนพิมพ์', link: '#' }, { name: 'อัพเดท Data order status.xlsx', link: '#' }, { name: 'Refresh Power BI (2. Order Status)', link: '#' }, { name: 'แคปภาพปรับ CU', link: '' }, { name: 'เปิดไฟล์ Order Report เอามาใส่ในแผนพิมพ์', link: '#' }
                ]},
                { id: 7, title: 'Update JOB Status', tasks: [
                    { name: 'เปิดไฟล์ Check Job เอามาใส่ในแผนพิมพ์ (Mon/Wed/Fri)', link: '#' }, { name: 'อัพเดท JobComplete และ ไม่ตรง order', link: '' }
                ]},
                { id: 8, title: 'Plan', tasks: [
                    { name: 'เปลี่ยนชื่อไฟล์อัพเดทวันที่', link: '' }, { name: 'Refresh Stock Room', link: '' }, { name: 'Refresh Workbook Link', link: '' }, { name: 'ส่งเมลรายงานวันที่', link: '' }
                ]},
                { id: 9, title: 'Auto Job', tasks: [
                    { name: 'เปิด Job ใหม่', link: '#' }, { name: 'อัพเดทไฟล์ AutoJob.xlsx', link: '#' }, { name: 'Refresh Power BI (3. AutoJob)', link: '#' }, { name: 'เอา Job ใส่แผนพิมพ์', link: '' }
                ]},
                { id: 10, title: 'เตรียมไฟล์ก่อน Upload', tasks: [
                    { name: 'เช็ค Job p', link: '' }, { name: 'เตรียม Planning + ตัวรีด', link: '' }, { name: 'Update Stock บ้าน', link: '' }, { name: 'Update CF', link: '' }, { name: 'Update แบบเหมือน', link: '' }, { name: 'ตรวจสอบไฟล์', link: '' }
                ]},
                { id: 11, title: 'Uplaod แผน', tasks: [
                    { name: 'ส่งไฟล์เข้า Connect Flexo โรง 4', link: '#' }, { name: 'Upload แบบลง Job Planning', link: '#' }, { name: 'Calculation + utility check', link: '#' }, { name: 'อัพเดท google sheet ให้ทีมคิด', link: '#' }, { name: 'เช็คลง Drive กลาง', link: '#' }
                ]},
                { id: 12, title: 'ทบทวน', tasks: [ { name: 'เช็คยอด CI', link: '' }, { name: 'ปล่อยแผน', link: '' } ]},
                { id: 15, title: 'Plan_Sales', tasks: [
                    { name: 'เปิดแผนพิมพ์', link: '#' }, { name: 'Refresh Workbook Link', link: '' }, { name: 'Refresh Stock Room', link: '' }, { name: 'อัพเดทตาราง', link: '' }, { name: 'เช็คแผน', link: '' }, { name: 'เช็คสินค้าใหม่', link: '' }, { name: 'ส่ง Mail ขาย', link: '' }
                ]},
                { id: 16, title: 'Plan_Machine', tasks: [
                    { name: 'Refresh แผนผลิต', link: '' }, { name: 'Update Workbook Link', link: '' }, { name: 'เปิดแผนพิมพ์', link: '#' }, { name: 'อัพเดทชีท', link: '' }, { name: 'ส่ง Mail แผนผลิต', link: '' }
                ]}
            ];
            const defaultShortcutsData = [
                { id: 1, name: 'Connect VPN', link: 'C:\\Program Files\\Fortinet\\FortiClient\\FortiClient.exe', icon: 'fa-shield-halved' },
                { id: 2, name: 'Power BI', link: '#', icon: 'fa-chart-line' },
                { id: 3, name: 'Styline', link: '#', icon: 'fa-file-alt' },
                { id: 4, name: 'GRCQ', link: '#', icon: 'fa-cogs' }
            ];

            // --- Data Loading ---
            function loadMasterData() {
                const savedTasks = localStorage.getItem('tasksMasterData');
                tasksMasterData = savedTasks ? JSON.parse(savedTasks) : defaultTasksData;

                const savedShortcuts = localStorage.getItem('shortcutsMasterData');
                shortcutsMasterData = savedShortcuts ? JSON.parse(savedShortcuts) : defaultShortcutsData;
            }

            // --- Helper function ---
            function formatDate(date) {
                const d = new Date(date);
                let month = '' + (d.getMonth() + 1);
                let day = '' + d.getDate();
                const year = d.getFullYear();
                if (month.length < 2) month = '0' + month;
                if (day.length < 2) day = '0' + day;
                return [year, month, day].join('-');
            }

            // --- Render Functions ---
            function renderShortcuts() {
                shortcutsContainer.innerHTML = '';
                shortcutsMasterData.forEach((shortcut, index) => {
                    if (isEditMode) {
                        const editDiv = document.createElement('div');
                        editDiv.className = 'flex items-center gap-2 p-2 border rounded-lg';
                        editDiv.innerHTML = `
                            <button class="change-icon-btn shortcut-btn !p-2" data-shortcut-index="${index}">
                                <i class="fas ${shortcut.icon || 'fa-link'}"></i>
                            </button>
                            <div class="flex flex-col gap-1">
                                <input type="text" value="${shortcut.name}" data-type="name" data-shortcut-index="${index}" class="p-1 border rounded text-sm" placeholder="Shortcut Name">
                                <input type="text" value="${shortcut.link}" data-type="link" data-shortcut-index="${index}" class="p-1 border rounded text-xs text-gray-500" placeholder="File Path or URL">
                            </div>
                            <button class="remove-shortcut-btn edit-action-btn" data-shortcut-index="${index}"><i class="fas fa-trash-alt"></i></button>
                        `;
                        shortcutsContainer.appendChild(editDiv);
                    } else {
                        const button = document.createElement('button');
                        button.className = 'shortcut-btn rounded-lg px-4 py-2 font-semibold';
                        button.dataset.link = shortcut.link;
                        button.innerHTML = `<i class="fas ${shortcut.icon || 'fa-link'} mr-2"></i>${shortcut.name}`;
                        
                        button.addEventListener('click', () => {
                            const link = button.dataset.link;
                            if (link && link !== '#') {
                                window.electronAPI.openFile(link);
                            }
                        });
                        shortcutsContainer.appendChild(button);
                    }
                });
                if(isEditMode) {
                    const addButton = document.createElement('button');
                    addButton.id = 'add-shortcut-btn';
                    addButton.className = 'shortcut-btn rounded-lg px-3 py-2 text-blue-500 border-blue-200 hover:bg-blue-50';
                    addButton.innerHTML = '<i class="fas fa-plus"></i> Add';
                    shortcutsContainer.appendChild(addButton);
                }
            }

            function renderTasks(date) {
                currentDate = date;
                taskGrid.innerHTML = '';

                tasksMasterData.forEach(workflow => {
                    const card = document.createElement('div');
                    card.className = 'task-card bg-white rounded-xl shadow-sm p-5 flex flex-col';
                    card.dataset.workflowId = workflow.id;

                    let tasksHtml = workflow.tasks.map((task, index) => {
                        const taskId = `task-${workflow.id}-${index}`;
                        if (isEditMode) {
                            return `
                                <div class="task-item-edit flex items-center gap-2 mb-2">
                                    <div class="flex-grow">
                                        <input type="text" value="${task.name}" data-type="name" data-workflow-id="${workflow.id}" data-task-index="${index}" class="w-full p-1 border rounded mb-1" placeholder="Task Name">
                                        <input type="text" value="${task.link || ''}" data-type="link" data-workflow-id="${workflow.id}" data-task-index="${index}" class="w-full p-1 border rounded text-sm text-gray-500" placeholder="File Path or URL">
                                    </div>
                                    <button class="remove-task-btn edit-action-btn" data-workflow-id="${workflow.id}" data-task-index="${index}"><i class="fas fa-trash-alt"></i></button>
                                </div>`;
                        } else {
                            const linkElement = (task.link && task.link !== '#')
                                ? `<button class="task-link-btn hover:underline text-left" data-link="${task.link}">${task.name} <i class="fas ${task.link.startsWith('http') ? 'fa-external-link-alt' : 'fa-folder-open'} fa-xs opacity-60"></i></button>`
                                : task.name;

                            return `
                                <div class="task-item flex items-center mb-2 last:mb-0">
                                    <input type="checkbox" id="${taskId}" class="h-5 w-5 rounded border-gray-300 text-green-500 focus:ring-green-500 cursor-pointer flex-shrink-0">
                                    <label for="${taskId}" class="ml-3 text-gray-700 cursor-pointer">${linkElement}</label>
                                </div>`;
                        }
                    }).join('');
                    
                    if (isEditMode) {
                        tasksHtml += `<button class="add-task-btn mt-2 text-sm text-blue-500 hover:underline w-full text-left" data-workflow-id="${workflow.id}"><i class="fas fa-plus mr-1"></i> เพิ่ม Task</button>`;
                    }
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-lg font-bold text-gray-900">${workflow.id}. ${workflow.title}</h3>
                            ${!isEditMode ? `<span id="progress-text-${workflow.id}" class="font-semibold text-gray-500">0%</span>` : ''}
                        </div>
                        ${!isEditMode && workflow.tasks.length > 0 ? `
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                            <div id="progress-bar-${workflow.id}" class="progress-bar-fg h-2.5 rounded-full"></div>
                        </div>` : ''}
                        <div class="task-list flex-grow">${tasksHtml}</div>`;
                    taskGrid.appendChild(card);
                });

                if (!isEditMode) {
                    const allCheckboxes = taskGrid.querySelectorAll('.task-item input[type="checkbox"]');
                    allCheckboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', () => {
                            updateProgress();
                            saveProgress();
                        });
                    });
                    loadProgress();
                    updateProgress();
                }
            }
            
            function renderAll(date) {
                renderShortcuts();
                renderTasks(date);
            }

            // --- Progress Logic ---
            function saveProgress() {
                const dateKey = `dailyTaskProgress-${formatDate(currentDate)}`;
                const progressState = {};
                const allCheckboxes = taskGrid.querySelectorAll('.task-item input[type="checkbox"]');
                allCheckboxes.forEach(checkbox => {
                    progressState[checkbox.id] = checkbox.checked;
                });
                localStorage.setItem(dateKey, JSON.stringify(progressState));
            }

            function loadProgress() {
                const dateKey = `dailyTaskProgress-${formatDate(currentDate)}`;
                const savedProgress = localStorage.getItem(dateKey);
                if (savedProgress) {
                    const progressState = JSON.parse(savedProgress);
                    const allCheckboxes = taskGrid.querySelectorAll('.task-item input[type="checkbox"]');
                    allCheckboxes.forEach(checkbox => {
                        if (progressState[checkbox.id]) {
                            checkbox.checked = true;
                        }
                    });
                }
            }

            function updateProgress() {
                let totalTasks = 0;
                let completedTasks = 0;

                tasksMasterData.forEach(workflow => {
                    if (workflow.tasks.length === 0) return;
                    const workflowCard = taskGrid.querySelector(`.task-card[data-workflow-id="${workflow.id}"]`);
                    if (!workflowCard) return;
                    
                    const workflowCheckboxes = workflowCard.querySelectorAll('input[type="checkbox"]');
                    const completedInWorkflow = Array.from(workflowCheckboxes).filter(cb => cb.checked).length;
                    const totalInWorkflow = workflowCheckboxes.length;
                    totalTasks += totalInWorkflow;
                    completedTasks += completedInWorkflow;

                    const percentage = totalInWorkflow > 0 ? (completedInWorkflow / totalInWorkflow) * 100 : 0;
                    const progressBar = workflowCard.querySelector(`#progress-bar-${workflow.id}`);
                    const progressText = workflowCard.querySelector(`#progress-text-${workflow.id}`);
                    if (progressBar) progressBar.style.width = `${percentage}%`;
                    if (progressText) progressText.textContent = `${Math.round(percentage)}%`;
                });

                document.getElementById('main-progress-details').textContent = `${completedTasks}/${totalTasks} Tasks`;
                const overallPercentage = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
                document.getElementById('main-progress-bar').style.width = `${overallPercentage}%`;
                document.getElementById('main-progress-text').textContent = `${Math.round(overallPercentage)}%`;
            }

            // --- Modal & Edit Handlers ---
            function handleEditToggle() {
                isEditMode = !isEditMode;
                if (isEditMode) {
                    editBtn.innerHTML = `<i class="fas fa-save mr-2"></i>บันทึก`;
                    editBtn.classList.replace('bg-blue-500', 'bg-green-500');
                } else {
                    const taskInputs = taskGrid.querySelectorAll('.task-item-edit input');
                    taskInputs.forEach(input => {
                        const workflowId = parseInt(input.dataset.workflowId);
                        const taskIndex = parseInt(input.dataset.taskIndex);
                        const type = input.dataset.type;
                        const workflow = tasksMasterData.find(w => w.id === workflowId);
                        if (workflow && workflow.tasks[taskIndex]) {
                            workflow.tasks[taskIndex][type] = input.value;
                        }
                    });
                    localStorage.setItem('tasksMasterData', JSON.stringify(tasksMasterData));

                    const shortcutInputs = shortcutsContainer.querySelectorAll('input');
                    shortcutInputs.forEach(input => {
                        const shortcutIndex = parseInt(input.dataset.shortcutIndex);
                        const type = input.dataset.type;
                        if (shortcutsMasterData[shortcutIndex]) {
                             shortcutsMasterData[shortcutIndex][type] = input.value;
                        }
                    });
                    localStorage.setItem('shortcutsMasterData', JSON.stringify(shortcutsMasterData));

                    editBtn.innerHTML = `<i class="fas fa-pencil-alt mr-2"></i>แก้ไขรายการ`;
                    editBtn.classList.replace('bg-green-500', 'bg-blue-500');
                }
                renderAll(currentDate);
            }

            function openIconPicker(index) {
                currentShortcutIndex = index;
                iconPickerGrid.innerHTML = '';
                availableIcons.forEach(iconClass => {
                    const item = document.createElement('div');
                    item.className = 'icon-picker-item';
                    item.dataset.iconClass = iconClass;
                    item.innerHTML = `<i class="fas ${iconClass} fa-lg"></i>`;
                    iconPickerGrid.appendChild(item);
                });
                iconPickerModal.classList.remove('opacity-0', 'pointer-events-none');
                iconPickerModal.querySelector('.modal-box').classList.remove('scale-95');
            }

            function closeIconPicker() {
                iconPickerModal.classList.add('opacity-0', 'pointer-events-none');
                iconPickerModal.querySelector('.modal-box').classList.add('scale-95');
            }

            function showClearModal() {
                clearModal.classList.remove('opacity-0', 'pointer-events-none');
                clearModal.querySelector('.modal-box').classList.remove('scale-95');
            }

            function hideClearModal() {
                clearModal.classList.add('opacity-0', 'pointer-events-none');
                clearModal.querySelector('.modal-box').classList.add('scale-95');
            }

            function handleClearTasks() {
                const dateKey = `dailyTaskProgress-${formatDate(currentDate)}`;
                localStorage.removeItem(dateKey);
                hideClearModal();
                renderTasks(currentDate);
            }

            // --- Event Delegation for Dynamic Elements ---
            document.addEventListener('click', function(e) {
                if (e.target && e.target.closest('#add-shortcut-btn')) {
                    shortcutsMasterData.push({ id: Date.now(), name: 'New Shortcut', link: '', icon: 'fa-link' });
                    renderShortcuts();
                }
                if (e.target && e.target.closest('.remove-shortcut-btn')) {
                    const index = e.target.closest('.remove-shortcut-btn').dataset.shortcutIndex;
                    shortcutsMasterData.splice(index, 1);
                    renderShortcuts();
                }
                if (e.target && e.target.closest('.change-icon-btn')) {
                    const index = e.target.closest('.change-icon-btn').dataset.shortcutIndex;
                    openIconPicker(index);
                }
                if (e.target && e.target.closest('.icon-picker-item')) {
                    const iconClass = e.target.closest('.icon-picker-item').dataset.iconClass;
                    if (currentShortcutIndex !== null) {
                        shortcutsMasterData[currentShortcutIndex].icon = iconClass;
                        renderShortcuts();
                        closeIconPicker();
                    }
                }
                if (e.target && e.target.classList.contains('add-task-btn')) {
                    const workflowId = parseInt(e.target.dataset.workflowId);
                    const workflow = tasksMasterData.find(w => w.id === workflowId);
                    if(workflow) {
                        workflow.tasks.push({ name: 'New Task', link: '' });
                        renderTasks(currentDate);
                    }
                }
                if (e.target && e.target.closest('.remove-task-btn')) {
                    const button = e.target.closest('.remove-task-btn');
                    const workflowId = parseInt(button.dataset.workflowId);
                    const taskIndex = parseInt(button.dataset.taskIndex);
                    const workflow = tasksMasterData.find(w => w.id === workflowId);
                    if(workflow) {
                        workflow.tasks.splice(taskIndex, 1);
                        renderTasks(currentDate);
                    }
                }
                if (e.target && e.target.closest('.task-link-btn')) {
                    const button = e.target.closest('.task-link-btn');
                    const link = button.dataset.link;
                    if (link && link !== '#') {
                        window.electronAPI.openFile(link);
                    }
                }
            });

            // --- Initial Setup ---
            datePicker.addEventListener('change', (event) => {
                const [year, month, day] = event.target.value.split('-').map(Number);
                const selectedDate = new Date(year, month - 1, day);
                renderAll(selectedDate);
            });
            todayBtn.addEventListener('click', () => {
                const today = new Date();
                datePicker.value = formatDate(today);
                renderAll(today);
            });
            editBtn.addEventListener('click', handleEditToggle);
            clearBtn.addEventListener('click', showClearModal);
            cancelClearBtn.addEventListener('click', hideClearModal);
            confirmClearBtn.addEventListener('click', handleClearTasks);
            closeIconPickerBtn.addEventListener('click', closeIconPicker);

            function initialize() {
                loadMasterData();
                const today = new Date();
                datePicker.value = formatDate(today);
                renderAll(today);
            }

            initialize();
        });
    </script>

</body>
</html>
