<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com https://cdnjs.cloudflare.com;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner Want to Go Home V.1.3</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    colors: {
                        brand: {
                            start: '#4F46E5', // Indigo-600
                            end: '#9333EA',   // Purple-600
                            light: '#EEF2FF'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F3F4F6; font-family: 'Sarabun', sans-serif; overflow: hidden; }
        
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        /* Sidebar Gradient */
        .sidebar-gradient {
            background: linear-gradient(180deg, #4F46E5 0%, #7C3AED 100%);
        }

        /* Glassmorphism Card */
        .task-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(229, 231, 235, 0.5);
            position: relative;
            overflow: hidden;
        }
        .task-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #A78BFA;
        }
        .task-card::before {
            content: ''; position: absolute; top: 0; left: 0; w: 100%; h: 4px;
            background: linear-gradient(90deg, #4F46E5, #9333EA);
            opacity: 0; transition: opacity 0.3s;
        }
        .task-card:hover::before { opacity: 1; }

        /* Checkbox Styling */
        .custom-checkbox {
            appearance: none;
            width: 1.25rem; height: 1.25rem;
            border: 2px solid #CBD5E1; border-radius: 6px;
            display: inline-flex; align-items: center; justify-content: center;
            transition: all 0.2s; cursor: pointer;
        }
        .custom-checkbox:checked {
            background-color: #7C3AED; border-color: #7C3AED;
        }
        .custom-checkbox:checked::after {
            content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            color: white; font-size: 0.75rem;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        /* Watch List Active State */
        .watching-active {
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
            border-color: #6366F1;
        }
        
        /* Edit Mode Input Highlight */
        .edit-input {
            border-bottom: 2px solid #E2E8F0;
            transition: border-color 0.2s;
        }
        .edit-input:focus {
            border-color: #6366F1;
            outline: none;
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex">

    <!-- Sidebar (Fixed Width 64 = 16rem) -->
    <aside id="sidebar" class="w-64 sidebar-gradient flex flex-col shadow-2xl z-20 flex-shrink-0">
        <div class="p-6 flex items-center gap-4 text-white">
            <div class="min-w-[2.5rem] h-10 rounded-xl bg-white/20 backdrop-blur flex items-center justify-center text-xl font-bold shadow-inner">
                <i class="fa-solid fa-house-person-return"></i>
            </div>
            <h1 class="font-bold text-lg whitespace-nowrap">Planner Home</h1>
        </div>

        <div class="flex-grow py-4 px-4 overflow-y-auto overflow-x-hidden custom-scrollbar">
            <div class="text-xs font-semibold text-indigo-200 uppercase tracking-wider mb-3 px-1">Shortcuts</div>
            <div id="shortcuts-container" class="space-y-2">
                <!-- Shortcuts Injected Here -->
            </div>
            
            <button id="add-shortcut-btn" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-indigo-100 border border-white/10 hover:bg-white/10 transition-colors mt-2 group">
                <i class="fa-solid fa-plus group-hover:scale-110 transition-transform"></i>
                <span class="text-sm font-medium">Add Shortcut</span>
            </button>
        </div>

        <div class="p-4 border-t border-white/10 bg-black/10 space-y-2">
            <!-- Import/Export Group -->
            <div class="flex gap-2">
                <!-- Import Button (New) -->
                <button id="import-template-btn" class="flex-1 flex items-center justify-center gap-2 px-3 py-2 text-indigo-100 hover:text-white hover:bg-white/10 rounded-lg transition-all border border-transparent hover:border-white/20" title="Import JSON">
                    <i class="fa-solid fa-file-import"></i>
                    <span class="text-sm">Import</span>
                </button>
                
                <!-- Export Button -->
                <button id="export-template-btn" class="flex-1 flex items-center justify-center gap-2 px-3 py-2 text-indigo-100 hover:text-white hover:bg-white/10 rounded-lg transition-all border border-transparent hover:border-white/20" title="Export JSON">
                    <i class="fa-solid fa-file-export"></i>
                    <span class="text-sm">Export</span>
                </button>
            </div>
            
            <!-- Reset Button -->
            <button id="reset-day-btn" class="w-full flex items-center gap-3 px-3 py-2 text-red-200 hover:text-white hover:bg-red-500/20 rounded-lg transition-all" title="Factory Reset">
                <i class="fa-solid fa-power-off w-5 text-center"></i>
                <span class="text-sm">Reset Data</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col h-screen overflow-hidden bg-[#F3F4F6] relative">
        
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md border-b border-gray-200 p-4 z-10 sticky top-0 shadow-sm">
            <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">
                        Planner Want to Go Home <span class="text-sm font-light text-gray-400">V.1.3</span>
                    </h2>
                    <div class="flex items-center gap-3 mt-1">
                        <span id="current-date-display" class="text-sm font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded-md">Today</span>
                        <span id="clock-display" class="text-sm font-bold text-indigo-600 w-24 inline-block text-center font-mono bg-indigo-50 rounded px-2">--:--:--</span>
                    </div>
                </div>

                <!-- Right Controls -->
                <div class="flex gap-4 items-start w-full xl:w-auto justify-end">
                    
                     <!-- WATCH LIST WIDGET -->
                    <div class="relative group/watch z-50">
                        <div id="watch-status-indicator" class="flex items-center gap-2 bg-white border border-gray-200 px-3 py-2 rounded-xl shadow-sm hover:shadow-md transition-all cursor-pointer">
                            <div class="relative">
                                <div class="w-2 h-2 rounded-full bg-gray-300" id="watch-dot"></div>
                                <div class="w-2 h-2 rounded-full bg-gray-300 absolute top-0 left-0 animate-ping opacity-0" id="watch-ping"></div>
                            </div>
                            <div class="flex flex-col leading-none">
                                <span class="text-[10px] font-bold text-gray-400">WATCH LIST</span>
                                <span class="text-xs font-semibold text-gray-700" id="watch-status-text">Inactive</span>
                            </div>
                            <i class="fa-solid fa-chevron-down text-gray-400 text-xs ml-1 transition-transform group-hover/watch:rotate-180"></i>
                        </div>
                        
                        <!-- Watch List Dropdown -->
                        <div class="absolute right-0 top-full mt-2 w-80 bg-white rounded-xl shadow-2xl border border-gray-100 p-4 hidden group-hover/watch:block hover:block animate-fade-in">
                            <div class="mb-3">
                                <label class="text-[10px] font-bold text-indigo-500 block mb-1 uppercase">Monitor Folder Path</label>
                                <div class="flex gap-2">
                                    <input type="text" id="watch-path-input" class="w-full text-xs border rounded p-1.5 bg-gray-50 focus:ring-1 focus:ring-indigo-500 outline-none" placeholder="Paste folder path here...">
                                    <button id="save-watch-btn" class="text-xs bg-indigo-600 text-white px-2.5 rounded hover:bg-indigo-700 transition-colors"><i class="fa-solid fa-save"></i></button>
                                </div>
                                <p class="text-[10px] text-gray-400 mt-1">*Auto-scans every 5 mins</p>
                            </div>
                            <div class="border-t border-gray-100 pt-2">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-[10px] font-bold text-gray-500">LATEST 5 FILES</span>
                                    <button id="refresh-watch-btn" class="text-indigo-500 hover:text-indigo-700 p-1" title="Scan Now"><i class="fa-solid fa-rotate"></i></button>
                                </div>
                                <div id="watch-list-items" class="space-y-2 max-h-48 overflow-y-auto pr-1 custom-scrollbar">
                                    <div class="text-xs text-gray-400 text-center py-4 bg-gray-50 rounded-lg border border-dashed border-gray-200">No folder configured</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Date & Edit Controls -->
                    <div class="flex items-center gap-1 bg-white rounded-xl p-1 shadow-sm border border-gray-100">
                        <input type="date" id="date-picker" class="border-none text-sm text-gray-600 focus:ring-0 cursor-pointer w-32">
                        <button id="today-btn" class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-100 flex items-center justify-center font-bold text-xs" title="Go to Today">T</button>
                    </div>

                    <button id="edit-mode-btn" class="bg-white border border-indigo-100 text-indigo-600 hover:bg-indigo-50 px-4 py-2 rounded-xl shadow-sm transition-all text-sm font-semibold flex items-center gap-2">
                        <i class="fa-solid fa-pen-to-square"></i> <span class="hidden sm:inline">Edit</span>
                    </button>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="mt-4 relative h-1.5 bg-gray-100 rounded-full overflow-hidden">
                <div id="overall-progress-bar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 transition-all duration-700 ease-out shadow-[0_0_10px_rgba(79,70,229,0.5)]" style="width: 0%"></div>
            </div>
        </header>

        <!-- Content Area -->
        <div id="scroll-container" class="flex-grow overflow-y-auto p-4 md:p-6 custom-scrollbar">
            <div id="task-grid" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6 pb-20">
                <!-- Cards will be injected here -->
            </div>
        </div>

        <!-- Add Workflow FAB -->
        <button id="add-workflow-fab" class="hidden fixed bottom-8 right-8 w-14 h-14 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-full shadow-lg shadow-indigo-300 hover:scale-110 hover:shadow-xl transition-all items-center justify-center text-2xl z-30">
            <i class="fa-solid fa-plus"></i>
        </button>

        <!-- Notification Toast -->
        <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 transform translate-y-20 opacity-0 transition-all duration-300 z-50 pointer-events-none">
            <div class="bg-gray-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 border border-gray-700">
                <i id="toast-icon" class="fa-solid fa-info-circle text-indigo-400"></i>
                <span id="toast-message" class="text-sm font-medium">Notification</span>
            </div>
        </div>

    </main>

    <!-- Import Hidden Input -->
    <input type="file" id="import-file-input" class="hidden" accept=".json">

    <script>
        // --- Core Application Logic ---

        if (typeof window.electronAPI === 'undefined') {
            window.electronAPI = {
                openFile: async (path) => { console.log(`[Sim] Open: ${path}`); return { success: true }; },
                scanFolder: async (path) => { 
                    console.log(`[Sim] Scan: ${path}`); 
                    return { success: true, files: [{name: 'SIM_Report_2025.xlsx', path: '#'}, {name: 'URGENT_PLAN.pdf', path: '#'}] }; 
                }
            };
        }

        const appState = {
            currentDate: new Date(),
            isEditMode: false,
            masterData: [],
            shortcuts: [],
            progress: {},
            watchPath: ''
        };

        // --- DEFAULT DATA ---
        const DEFAULT_DATA = [
            { "id": 1, "title": "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô", "tasks": [ { "name": "Login Citrix", "link": "microsoft-edge:http://172.16.10.80/Citrix/XenApp/auth/login.aspx" }, { "name": "‡πÄ‡∏õ‡∏¥‡∏î Power Bi", "link": "D:\\Project\\0.Power Bi\\Planning\\Digital Management_PLP Version 2025 Rev.0.2.pbix" } ] }
        ];

        // --- Watch List Logic ---
        async function updateWatchList() {
            const listContainer = document.getElementById('watch-list-items');
            const indicator = document.getElementById('watch-dot');
            const ping = document.getElementById('watch-ping');
            const statusText = document.getElementById('watch-status-text');
            const wrapper = document.getElementById('watch-status-indicator');

            if (!appState.watchPath) {
                listContainer.innerHTML = '<div class="text-xs text-gray-400 text-center py-4 bg-gray-50 rounded-lg border border-dashed border-gray-200">No folder configured</div>';
                indicator.className = 'w-2 h-2 rounded-full bg-gray-300';
                ping.className = 'hidden';
                statusText.innerText = 'Inactive';
                wrapper.classList.remove('watching-active');
                return;
            }

            indicator.className = 'w-2 h-2 rounded-full bg-yellow-400';
            statusText.innerText = 'Scanning...';
            
            const result = await window.electronAPI.scanFolder(appState.watchPath);
            listContainer.innerHTML = '';
            
            if (result.success && result.files && result.files.length > 0) {
                indicator.className = 'w-2 h-2 rounded-full bg-green-500';
                ping.className = 'w-2 h-2 rounded-full bg-green-500 absolute top-0 left-0 animate-ping opacity-75';
                statusText.innerText = 'Active';
                wrapper.classList.add('watching-active');
                
                result.files.forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-2.5 bg-indigo-50/50 hover:bg-indigo-50 border border-indigo-100/50 rounded-lg cursor-pointer transition-all group mb-1';
                    div.onclick = () => window.electronAPI.openFile(file.path);
                    div.innerHTML = `
                        <div class="flex items-center gap-2.5 overflow-hidden">
                            <div class="w-8 h-8 rounded bg-white flex items-center justify-center text-indigo-500 shadow-sm border border-indigo-50">
                                <i class="fa-solid fa-file-lines text-xs"></i>
                            </div>
                            <div class="flex flex-col overflow-hidden">
                                <span class="text-xs text-indigo-900 truncate font-semibold">${file.name}</span>
                                <span class="text-[10px] text-gray-500 truncate">Click to open</span>
                            </div>
                        </div>
                        <i class="fa-solid fa-arrow-up-right-from-square text-xs text-indigo-300 group-hover:text-indigo-600 transition-colors"></i>
                    `;
                    listContainer.appendChild(div);
                });
            } else {
                indicator.className = 'w-2 h-2 rounded-full bg-gray-400';
                ping.className = 'hidden';
                statusText.innerText = 'No Files';
                wrapper.classList.remove('watching-active');
                listContainer.innerHTML = `<div class="text-xs text-gray-500 text-center py-4 bg-gray-50 rounded-lg">${result.error || 'No recent files found'}</div>`;
            }
        }

        // --- Initialization ---
        function init() {
            loadData();
            setupEventListeners();
            renderAll();
            startClock();
            if(appState.watchPath) updateWatchList();
            setInterval(() => { if(appState.watchPath) updateWatchList(); }, 300000); 
        }

        function loadData() {
            const savedPath = localStorage.getItem('watchFolderPath');
            appState.watchPath = savedPath || '';
            document.getElementById('watch-path-input').value = appState.watchPath;

            const savedData = localStorage.getItem('taskMasterData');
            if (savedData) {
                appState.masterData = JSON.parse(savedData);
            } else {
                appState.masterData = DEFAULT_DATA;
            }
            
            const savedShortcuts = localStorage.getItem('shortcutData');
            appState.shortcuts = savedShortcuts ? JSON.parse(savedShortcuts) : [];

            loadProgress();
        }

        function loadProgress() {
            const key = `progress_${appState.currentDate.toISOString().split('T')[0]}`;
            appState.progress = JSON.parse(localStorage.getItem(key)) || {};
        }

        function saveData() {
            localStorage.setItem('taskMasterData', JSON.stringify(appState.masterData));
            localStorage.setItem('shortcutData', JSON.stringify(appState.shortcuts));
            localStorage.setItem('watchFolderPath', appState.watchPath);
        }

        function saveProgress() {
            const key = `progress_${appState.currentDate.toISOString().split('T')[0]}`;
            localStorage.setItem(key, JSON.stringify(appState.progress));
            updateProgressBar();
        }

        // --- Rendering ---
        function renderAll() {
            renderDate();
            renderShortcuts();
            renderTasks();
            updateProgressBar();
            updateEditModeUI();
        }

        function renderDate() {
            const options = { weekday: 'short', day: 'numeric', month: 'short' };
            document.getElementById('current-date-display').innerText = appState.currentDate.toLocaleDateString('en-US', options); 
            document.getElementById('date-picker').value = appState.currentDate.toISOString().split('T')[0];
        }

        function renderShortcuts() {
            const container = document.getElementById('shortcuts-container');
            container.innerHTML = '';
            appState.shortcuts.forEach((sc, idx) => {
                const btn = document.createElement('div');
                
                if(appState.isEditMode) {
                    btn.className = 'flex flex-col gap-1 p-3 bg-white/10 rounded-lg border border-white/20 mb-3';
                    btn.innerHTML = `
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-bold text-indigo-200 uppercase">Shortcut Name</label>
                            <input type="text" value="${sc.name}" class="text-xs bg-black/20 text-white rounded p-1 border border-white/10 focus:outline-none focus:border-white/50" onchange="updateShortcut(${idx}, 'name', this.value)">
                        </div>
                        <div class="flex flex-col gap-1 mt-1">
                            <label class="text-[10px] font-bold text-indigo-200 uppercase">File Path / URL</label>
                            <input type="text" value="${sc.link}" class="text-[10px] bg-black/20 text-indigo-100 rounded p-1 border border-white/10 focus:outline-none focus:border-white/50" onchange="updateShortcut(${idx}, 'link', this.value)">
                        </div>
                        <button onclick="deleteShortcut(${idx})" class="text-[10px] text-red-300 hover:text-red-100 bg-red-500/20 py-1 rounded mt-1">Delete</button>
                    `;
                } else {
                    btn.className = 'flex items-center gap-3 px-3 py-2.5 rounded-xl text-indigo-50 hover:bg-white/10 hover:text-white transition-all cursor-pointer group/item border border-transparent hover:border-white/10';
                    btn.onclick = () => window.electronAPI.openFile(sc.link);
                    btn.innerHTML = `
                        <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center group-hover/item:bg-white/20 transition-colors">
                            <i class="fa-solid fa-bolt text-sm text-yellow-300"></i>
                        </div>
                        <span class="whitespace-nowrap text-sm font-medium">${sc.name}</span>
                    `;
                }
                container.appendChild(btn);
            });
        }

        function renderTasks() {
            const grid = document.getElementById('task-grid');
            grid.innerHTML = '';

            appState.masterData.forEach((wf, wfIdx) => {
                const card = document.createElement('div');
                card.className = 'task-card flex flex-col h-full animate-fade-in p-5';
                card.style.animationDelay = `${wfIdx * 0.05}s`;

                let header = '';
                if(appState.isEditMode) {
                    header = `
                        <div class="flex items-center gap-2 mb-4 border-b border-gray-100 pb-2">
                            <i class="fa-solid fa-grip-vertical text-gray-300 cursor-move handle hover:text-indigo-500"></i>
                            <input type="text" value="${wf.title}" class="font-bold text-gray-700 bg-transparent focus:outline-none w-full border-b border-transparent focus:border-indigo-500 transition-all" onchange="updateWorkflowTitle(${wfIdx}, this.value)">
                            <button onclick="deleteWorkflow(${wfIdx})" class="text-red-400 hover:text-red-600 p-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                } else {
                    const completedCount = wf.tasks.filter((_, tIdx) => appState.progress[`${wfIdx}_${tIdx}`]).length;
                    const total = wf.tasks.length;
                    const percent = total === 0 ? 0 : Math.round((completedCount/total)*100);
                    
                    header = `
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="font-bold text-lg text-slate-800 line-clamp-1 border-l-4 border-indigo-500 pl-3" title="${wf.title}">${wf.title}</h3>
                            <span class="text-[10px] font-bold px-2 py-1 rounded-full ${percent === 100 ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'}">${percent}%</span>
                        </div>
                    `;
                }

                let taskList = `<div class="space-y-2 flex-grow sortable-tasks" data-wf="${wfIdx}">`;
                wf.tasks.forEach((task, tIdx) => {
                    if(appState.isEditMode) {
                        taskList += `
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 group/edit shadow-sm">
                                <div class="flex gap-2 mb-2">
                                    <div class="flex-grow">
                                        <label class="text-[10px] font-bold text-gray-400 uppercase">Task Name</label>
                                        <input type="text" value="${task.name}" class="text-sm w-full bg-white border border-gray-200 rounded p-1 focus:outline-none focus:border-indigo-500" onchange="updateTask(${wfIdx}, ${tIdx}, 'name', this.value)">
                                    </div>
                                    <button onclick="removeTask(${wfIdx}, ${tIdx})" class="text-gray-300 hover:text-red-500 mt-4"><i class="fa-solid fa-times"></i></button>
                                </div>
                                <div class="mb-2">
                                    <label class="text-[10px] font-bold text-gray-400 uppercase">File Path / URL</label>
                                    <input type="text" value="${task.link || ''}" class="text-[10px] w-full bg-white border border-gray-200 rounded p-1 text-gray-500 focus:outline-none focus:border-indigo-500" onchange="updateTask(${wfIdx}, ${tIdx}, 'link', this.value)">
                                </div>
                                <div class="flex gap-2">
                                    <div class="w-1/2">
                                        <label class="text-[10px] font-bold text-gray-400 uppercase">Width (Web Only)</label>
                                        <input type="number" value="${task.width || ''}" placeholder="e.g. 800" class="text-[10px] w-full bg-white border border-gray-200 rounded p-1 text-gray-500 focus:outline-none focus:border-indigo-500" onchange="updateTask(${wfIdx}, ${tIdx}, 'width', this.value)">
                                    </div>
                                    <div class="w-1/2">
                                        <label class="text-[10px] font-bold text-gray-400 uppercase">Height (Web Only)</label>
                                        <input type="number" value="${task.height || ''}" placeholder="e.g. 600" class="text-[10px] w-full bg-white border border-gray-200 rounded p-1 text-gray-500 focus:outline-none focus:border-indigo-500" onchange="updateTask(${wfIdx}, ${tIdx}, 'height', this.value)">
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        const isDone = appState.progress[`${wfIdx}_${tIdx}`];
                        const linkBtn = task.link ? `<button onclick="openLink('${task.link.replace(/\\/g, '\\\\')}', ${task.width}, ${task.height})" class="text-indigo-400 hover:text-indigo-600 ml-auto p-1 rounded hover:bg-indigo-50 transition-colors" title="Open Link"><i class="fa-solid fa-arrow-up-right-from-square"></i></button>` : '';
                        
                        taskList += `
                            <div class="flex items-center gap-3 p-2.5 rounded-lg hover:bg-gray-50 transition-colors group cursor-pointer border border-transparent hover:border-gray-100" onclick="toggleTask(${wfIdx}, ${tIdx})">
                                <div class="relative flex items-center justify-center">
                                    <input type="checkbox" class="custom-checkbox" ${isDone ? 'checked' : ''}>
                                </div>
                                <span class="text-sm text-gray-600 ${isDone ? 'line-through text-gray-400' : ''} select-none flex-grow font-medium">${task.name}</span>
                                <div onclick="event.stopPropagation()">${linkBtn}</div>
                            </div>
                        `;
                    }
                });
                taskList += '</div>';

                let footer = '';
                if(appState.isEditMode) {
                    footer = `<button onclick="addTask(${wfIdx})" class="mt-3 w-full py-2 border border-dashed border-indigo-200 text-indigo-500 rounded-lg text-xs font-semibold hover:bg-indigo-50 transition-colors">+ Add Task</button>`;
                } else if (wf.tasks.some(t => t.link)) {
                    footer = `
                        <button onclick="runMacro(${wfIdx})" class="mt-4 w-full py-2 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-600 hover:text-white transition-all flex items-center justify-center gap-2 group/btn">
                            <i class="fa-solid fa-rocket group-hover/btn:animate-bounce"></i> Launch All Apps
                        </button>
                    `;
                }

                card.innerHTML = header + taskList + footer;
                grid.appendChild(card);
            });

            if(appState.isEditMode) {
                initSortable();
            }
        }

        function updateProgressBar() {
            let total = 0, done = 0;
            appState.masterData.forEach((wf, wIdx) => wf.tasks.forEach((_, tIdx) => {
                total++;
                if(appState.progress[`${wIdx}_${tIdx}`]) done++;
            }));
            const pct = total === 0 ? 0 : (done/total)*100;
            document.getElementById('overall-progress-bar').style.width = `${pct}%`;
        }

        function updateEditModeUI() {
            const btn = document.getElementById('edit-mode-btn');
            const fab = document.getElementById('add-workflow-fab');
            const sidebar = document.getElementById('sidebar');

            if(appState.isEditMode) {
                btn.innerHTML = '<i class="fa-solid fa-check"></i> <span class="hidden sm:inline">Done</span>';
                btn.classList.add('bg-green-500', 'text-white', 'border-transparent');
                btn.classList.remove('bg-white', 'text-indigo-600', 'border-indigo-100');
                fab.classList.remove('hidden');
                fab.classList.add('flex');
            } else {
                btn.innerHTML = '<i class="fa-solid fa-pen-to-square"></i> <span class="hidden sm:inline">Edit</span>';
                btn.classList.remove('bg-green-500', 'text-white', 'border-transparent');
                btn.classList.add('bg-white', 'text-indigo-600', 'border-indigo-100');
                fab.classList.remove('flex');
                fab.classList.add('hidden');
            }
        }

        function showToast(msg, type='info') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            
            const icon = document.getElementById('toast-icon');
            if(type === 'error') icon.className = 'fa-solid fa-circle-exclamation text-red-400';
            else icon.className = 'fa-solid fa-circle-info text-indigo-400';

            toast.classList.remove('opacity-0', 'translate-y-20');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-20'), 3000);
        }

        // --- EXPORT & IMPORT FUNCTIONS ---
        function exportTemplate() {
            const dataToExport = {
                exportedAt: new Date().toISOString(),
                shortcuts: appState.shortcuts,
                masterData: appState.masterData
            };
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `planner_template_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Template exported successfully!', 'success');
        }

        function importTemplate(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    // Basic validation
                    if (data.masterData && Array.isArray(data.masterData)) {
                        if (confirm('Importing will overwrite current layouts. Continue?')) {
                            appState.masterData = data.masterData;
                            if (data.shortcuts) appState.shortcuts = data.shortcuts;
                            saveData();
                            renderAll();
                            showToast('Template loaded successfully!', 'success');
                        }
                    } else {
                        showToast('Invalid JSON template format', 'error');
                    }
                } catch (err) {
                    showToast('Error reading file', 'error');
                }
                event.target.value = ''; // Reset
            };
            reader.readAsText(file);
        }

        // --- OPEN FILE LOGIC ---
        function openLink(path, w, h) {
            if (path.startsWith('http') && w && h) {
                // Open Web Link with specific size
                window.open(path, '_blank', `width=${w},height=${h},left=100,top=100`);
            } else {
                // Open Local File or standard link
                window.electronAPI.openFile(path);
            }
        }

        // --- Event Handlers & Actions ---

        function toggleTask(wfIdx, tIdx) {
            if(appState.isEditMode) return;
            const key = `${wfIdx}_${tIdx}`;
            appState.progress[key] = !appState.progress[key];
            saveProgress();
            renderTasks();
        }

        async function runMacro(wfIdx) {
            const tasks = appState.masterData[wfIdx].tasks.filter(t => t.link);
            showToast(`üöÄ Launching ${tasks.length} apps...`);
            for(const t of tasks) {
                openLink(t.link, t.width, t.height);
                await new Promise(r => setTimeout(r, 800)); // Delay
            }
        }

        function toggleEditMode() {
            appState.isEditMode = !appState.isEditMode;
            if(!appState.isEditMode) {
                saveData(); // Save on exit
                showToast('Layout saved successfully');
            }
            updateEditModeUI();
            renderAll();
        }

        // Data Manipulation
        window.updateWorkflowTitle = (idx, val) => { appState.masterData[idx].title = val; };
        window.updateTask = (wIdx, tIdx, field, val) => { appState.masterData[wIdx].tasks[tIdx][field] = val; };
        window.addTask = (wIdx) => { appState.masterData[wIdx].tasks.push({name:'', link:''}); renderTasks(); };
        window.removeTask = (wIdx, tIdx) => { appState.masterData[wIdx].tasks.splice(tIdx, 1); renderTasks(); };
        window.deleteWorkflow = (idx) => { if(confirm('Delete workflow?')) { appState.masterData.splice(idx, 1); renderTasks(); }};
        window.updateShortcut = (idx, field, val) => { appState.shortcuts[idx][field] = val; };
        window.deleteShortcut = (idx) => { appState.shortcuts.splice(idx, 1); renderShortcuts(); };

        function setupEventListeners() {
            document.getElementById('export-template-btn').onclick = exportTemplate;
            
            // Import Button Logic
            const importBtn = document.getElementById('import-template-btn');
            const fileInput = document.getElementById('import-file-input');
            if(importBtn && fileInput) {
                importBtn.onclick = () => fileInput.click();
                fileInput.onchange = importTemplate;
            }

            document.getElementById('save-watch-btn').onclick = () => {
                appState.watchPath = document.getElementById('watch-path-input').value;
                saveData();
                updateWatchList();
                showToast('Watch folder updated');
            };
            document.getElementById('refresh-watch-btn').onclick = () => {
                updateWatchList();
                showToast('Scanning folder...');
            };

            document.getElementById('edit-mode-btn').onclick = toggleEditMode;
            document.getElementById('add-workflow-fab').onclick = () => {
                appState.masterData.push({id: Date.now(), title: 'New Plan', tasks: []});
                renderTasks();
                setTimeout(() => {
                    const container = document.getElementById('scroll-container');
                    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                }, 100);
            };
            document.getElementById('add-shortcut-btn').onclick = () => {
                appState.shortcuts.push({name:'New Link', link:''});
                if(!appState.isEditMode) showToast('Enter Edit Mode to configure link', 'warning');
                renderShortcuts();
            };
            document.getElementById('reset-day-btn').onclick = () => {
                if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á)')) {
                    localStorage.removeItem('taskMasterData');
                    appState.progress = {};
                    saveProgress();
                    location.reload(); 
                }
            };
            document.getElementById('today-btn').onclick = () => {
                appState.currentDate = new Date();
                loadProgress();
                renderAll();
            };
            document.getElementById('date-picker').onchange = (e) => {
                appState.currentDate = new Date(e.target.value);
                loadProgress();
                renderAll();
            };
        }

        // Drag & Drop
        function initSortable() {
            new Sortable(document.getElementById('task-grid'), { handle: '.handle', animation: 150 });
            document.querySelectorAll('.sortable-tasks').forEach(el => {
                new Sortable(el, { group: 'tasks', animation: 150, onEnd: () => {
                }});
            });
        }

        function startClock() {
            // Updated for HH:MM:SS
            setInterval(() => {
                document.getElementById('clock-display').innerText = new Date().toLocaleTimeString('th-TH', {
                    hour:'2-digit', 
                    minute:'2-digit', 
                    second:'2-digit'
                });
            }, 1000);
        }

        init();
    </script>
</body>
</html>